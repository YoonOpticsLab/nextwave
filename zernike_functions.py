import numpy as np

MAX_ZERNIKES=65 # Absolute max for 10th order: np.sum( np.arange(10+1+1))-1 .first of 11th order is np.sum(np.arange(12)) )
MAX_ORDER=10

NUM_ZCS=21 # 
START_ZC=1

# Order copied from MATLAB code
CVS_to_OSA_map = np.array([ 3, 2,
                            5, 4, 6,
                            9, 7, 8,10,
                            15,13,11,12,14,
                            21,19,17,16,18,20,
                            27,25,23,22,24,26,28,
                            35,33,31,29,30,32,34,36,
                            45,43,41,39,37,38,40,42,44,
                            55,53,51,49,47,46,48,50,52,54,
                            65,63,61,59,57,56,58,60,62,64,66], dtype='int')
CVS_to_OSA_map -= 2
OSA_to_CVS_map = np.array( [np.where(CVS_to_OSA_map==n)[0][0] for n in np.arange(len(CVS_to_OSA_map))] , dtype='int') 

def calc_rms(zernikes,pupil_radius_mm):
    radius = pupil_radius_mm
    radius2 = radius*radius
    EPS=1e-10
    sqrt3=np.sqrt(3.0)
    sqrt6=np.sqrt(6.0)
    z3=zernikes[3-1]
    z4=zernikes[4-1]
    z5=zernikes[5-1]

    J45 =  (-2.0 * sqrt6 / radius2) * z3
    J180 = (-2.0 * sqrt6 / radius2) * z5
    cylinder = (4.0 * sqrt6 / (radius * radius)) * np.sqrt((z3 * z3) + (z5 * z5))
    sphere = (-4.0 * sqrt3 * z4 / (radius * radius)) - 0.5 * cylinder

    if (np.abs(z5) <= EPS):
        thetaRad = 1.0 if (np.abs(z3) > EPS) else -1.0
        thetaRad *= float(np.pi) / 4.0
    else:
        thetaRad = 0.5 * np.arctan(J45 / J180)

    axis = thetaRad * 180.0 / float(np.pi)
    if (axis < 0.0):
        axis += 180.0

    rms=np.sqrt( np.nansum(zernikes[(3-1):]**2 ) )
    rms5p=np.sqrt( np.nansum(zernikes[(6-1):]**2 ) )

    return rms,rms5p,cylinder,sphere,axis


# These were copied directly from MATLAB Code Zernike_integral_[XY]
# Only changes were: change "^" to "**"
# Change parentheses in leftside using reg expression: s/intx(\(.*\))=/intx[\1]=/g
# Some whitespace, and changing some errant []s to ()s

# The simple functions return integrals for one array of positions:
def zernike_intx1(x,y,terms=70):
    zernike_intx=np.zeros( (terms+1, x.shape[0]) ) # Add one since these come from MATLAB and are one-based
    #zernike_intx[1]=0;
    zernike_intx[2]=x**2;
    zernike_intx[3]=2*x*y;
    zernike_intx[4]=3**(1/2)*(2/3*x**3+2*x*y**2-x);
    zernike_intx[5]=6**(1/2)*y*x**2;
    zernike_intx[6]=6**(1/2)*(1/3*x**3-x*y**2);
    zernike_intx[7]=2*2**(1/2)*y*(-2*x+x**3+3*x*y**2);
    zernike_intx[8]=2*2**(1/2)*(3/4*x**4+1/2*(-2+3*y**2)*x**2);
    zernike_intx[9]=2*2**(1/2)*y*(-x*y**2+x**3);
    zernike_intx[10]=2*2**(1/2)*(1/4*x**4-3/2*x**2*y**2);
    zernike_intx[11]=5**(1/2)*(6/5*x**5+4*x**3*y**2+6*x*y**4-2*x**3-6*x*y**2+x);
    zernike_intx[12]=10**(1/2)*(4/5*x**5-x**3-y**2*(-3+4*y**2)*x);
    zernike_intx[13]=2*10**(1/2)*y*(x**4+1/2*(-3+4*y**2)*x**2);
    zernike_intx[14]=10**(1/2)*(x*y**4+1/5*x**5-2*x**3*y**2);
    zernike_intx[15]=4*10**(1/2)*y*(-1/2*x**2*y**2+1/4*x**4);
    zernike_intx[16]=2*3**(1/2)*(5/3*x**6+1/4*(-12+20*y**2)*x**4+1/2*(3-12*y**2+10*y**4)*x**2);
    zernike_intx[17]=2*3**(1/2)*y*(3*x-4*x**3-12*x*y**2+2*x**5+20/3*x**3*y**2+10*x*y**4);
    zernike_intx[18]=2*3**(1/2)*(5/6*x**6+1/4*(-10*y**2-4)*x**4-3/2*y**2*(-4+5*y**2)*x**2);
    zernike_intx[19]=-2*3**(1/2)*y*(-3*x**5+1/3*(-4+10*y**2)*x**3+y**2*(-4+5*y**2)*x-4/3*(-4+5*y**2)*x**3);
    zernike_intx[20]=2*3**(1/2)*(1/6*x**6-5/2*x**4*y**2+5/2*x**2*y**4);
    zernike_intx[21]=2*3**(1/2)*y*(x**5-10/3*x**3*y**2+x*y**4);
    zernike_intx[22]=7**(1/2)*(20/7*x**7+12*y**2*x**5+20*y**4*x**3+20*y**6*x-6*x**5-20*x**3*y**2-30*x*y**4+4*x**3+12*x*y**2-x);
    zernike_intx[23]=2*14**(1/2)*y*(5/2*x**6+1/4*(-20+30*y**2)*x**4+1/2*(6-20*y**2+15*y**4)*x**2);
    zernike_intx[24]=-14**(1/2)*(-15/7*x**7+1/5*(-15*y**2+20)*x**5+1/3*(y**2*(-20+30*y**2)-6+20*y**2-15*y**4)*x**3+y**2*(6-20*y**2+15*y**4)*x);
    zernike_intx[25]=4*14**(1/2)*y*(x**6-5/4*x**4-1/2*y**2*(-5+6*y**2)*x**2);
    zernike_intx[26]=14**(1/2)*(6/7*x**7+1/5*(-30*y**2-5)*x**5+1/3*(6*y**4-6*y**2*(-5+6*y**2))*x**3+y**4*(-5+6*y**2)*x);
    zernike_intx[27]=2*14**(1/2)*y*(1/2*x**6-5/2*x**4*y**2+3/2*x**2*y**4);
    zernike_intx[28]=14**(1/2)*(1/7*x**7-3*y**2*x**5+5*y**4*x**3-y**6*x);
    zernike_intx[29]=4*y*(-4*x+10*x**3+30*x*y**2-12*x**5-40*x**3*y**2-60*x*y**4+5*x**7+21*y**2*x**5+35*y**4*x**3+35*y**6*x);
    zernike_intx[30]=35/2*x**8+2/3*(-60+105*y**2)*x**6+(30-120*y**2+105*y**4)*x**4+2*(-4+30*y**2-60*y**4+35*y**6)*x**2;
    zernike_intx[31]=-4*y*(-9*x**7+1/5*(-30+63*y**2)*x**5+1/3*(10-30*y**2+21*y**4+(-30+42*y**2)*y**2)*x**3+(10-30*y**2+21*y**4)*y**2*x-4/5*(-30+42*y**2)*x**5-4/3*(10-30*y**2+21*y**4)*x**3);
    zernike_intx[32]=21/2*x**8+1/6*(-84*y**2-120)*x**6+1/4*(-12*(-30+42*y**2)*y**2+40-120*y**2+84*y**4)*x**4-6*(10-30*y**2+21*y**4)*y**2*x**2;
    zernike_intx[33]=20*x**7*y+80*x**3*y**3-24*x**5*y-24*y**5*x+28*y**7*x-28*x**5*y**3-84*y**5*x**3;
    zernike_intx[34]=7/2*x**8+2/3*(-63*y**2-6)*x**6+(35*y**4-10*y**2*(-6+7*y**2))*x**4+10*y**4*(-6+7*y**2)*x**2;
    zernike_intx[35]=4*x**7*y-28*x**5*y**3+28*y**5*x**3-4*y**7*x;
    zernike_intx[36]=1/2*x**8-14*x**6*y**2+35*x**4*y**4-14*x**2*y**6;
    zernike_intx[37]=70/3*x**9+120*y**2*x**7+252*y**4*x**5+280*y**6*x**3+210*y**8*x-60*x**7-252*y**2*x**5-420*y**4*x**3-420*y**6*x+54*x**5+180*x**3*y**2+270*x*y**4-20*x**3-60*x*y**2+3*x;
    zernike_intx[38]=-3*2**(1/2)*(-56/9*x**9+1/7*(-105+224*y**2)*x**7+1/5*(60-210*y**2+168*y**4+(-105+168*y**2)*y**2)*x**5+1/3*(-10+60*y**2-105*y**4+56*y**6+(60-210*y**2+168*y**4)*y**2)*x**3+(-10+60*y**2-105*y**4+56*y**6)*y**2*x-2/7*(-105+168*y**2)*x**7-2/5*(60-210*y**2+168*y**4)*x**5-2/3*(-10+60*y**2-105*y**4+56*y**6)*x**3);
    zernike_intx[39]=6*2**(1/2)*y*(7*x**8+1/6*(-105+168*y**2)*x**6+1/4*(60-210*y**2+168*y**4)*x**4+1/2*(-10+60*y**2-105*y**4+56*y**6)*x**2);
    zernike_intx[40]=3*2**(1/2)*(28/9*(-3+2*2**(1/2))*(-3-2*2**(1/2))*x**9+1/7*(28*y**2*(-3-2*2**(1/2))+28*(-3+2*2**(1/2))*y**2+(-3+2*2**(1/2))*(-3-2*2**(1/2))*(-42+56*y**2))*x**7+1/5*(28*y**4+(y**2*(-3-2*2**(1/2))+(-3+2*2**(1/2))*y**2)*(-42+56*y**2)+(-3+2*2**(1/2))*(-3-2*2**(1/2))*(15-42*y**2+28*y**4))*x**5+1/3*(y**4*(-42+56*y**2)+(y**2*(-3-2*2**(1/2))+(-3+2*2**(1/2))*y**2)*(15-42*y**2+28*y**4))*x**3+y**4*(15-42*y**2+28*y**4)*x);
    zernike_intx[41]=-12*2**(1/2)*y*(-7/2*x**8+1/6*(-28*y**2+42)*x**6+1/4*(y**2*(-42+56*y**2)-15+42*y**2-28*y**4)*x**4+1/2*y**2*(15-42*y**2+28*y**4)*x**2);
    zernike_intx[42]=3*2**(1/2)*(8/9*x**9+1/7*(-7-112*y**2)*x**7+1/6*(-(-7+16*y**2)*y+(-7-16*y**2)*y+32*y**3)*x**6+1/5*(-2*(-7+8*y**2)*y**2+(4*(-7+8*y**2)*y-(-7+16*y**2)*y)*y-4*(4*(-7+8*y**2)*y-(-7+16*y**2)*y+(-7-16*y**2)*y)*y)*x**5+1/4*(-4*(-7+8*y**2)*y**3-4*(-3*(-7+8*y**2)*y**2+(4*(-7+8*y**2)*y-(-7+16*y**2)*y)*y)*y+(4*(-7+8*y**2)*y-(-7+16*y**2)*y+(-7-16*y**2)*y)*y**2)*x**4+1/3*(15*(-7+8*y**2)*y**4+(-3*(-7+8*y**2)*y**2+(4*(-7+8*y**2)*y-(-7+16*y**2)*y)*y)*y**2)*x**3-(-7+8*y**2)*y**6*x);
    zernike_intx[43]=6*2**(1/2)*y*(3*x**8+1/6*(-21-56*y**2)*x**6+1/4*(-9*(-7+8*y**2)*y**2-(-7-16*y**2)*y**2)*x**4+3/2*(-7+8*y**2)*y**4*x**2);
    zernike_intx[44]=3*2**(1/2)*(1/9*x**9-4*y**2*x**7+14*y**4*x**5-28/3*y**6*x**3+y**8*x);
    zernike_intx[45]=24*2**(1/2)*y*(1/8*x**8-7/6*x**6*y**2+7/4*x**4*y**4-1/2*x**2*y**6);
    zernike_intx[46]=2*5**(1/2)*(63/5*x**10+1/8*(-280+504*y**2)*x**8+1/6*(210-840*y**2+756*y**4)*x**6+1/4*(-60+420*y**2-840*y**4+504*y**6)*x**4+1/2*(5-60*y**2+210*y**4-280*y**6+126*y**8)*x**2);
    zernike_intx[47]=2*5**(1/2)*y*(5*x-20*x**3-60*x*y**2+42*x**5+140*x**3*y**2+210*x*y**4-40*x**7-168*y**2*x**5-280*y**4*x**3-280*y**6*x+14*x**9+72*y**2*x**7+756/5*y**4*x**5+168*y**6*x**3+126*y**8*x);
    zernike_intx[48]=-2*5**(1/2)*(-42/5*x**10+21*x**8+1/6*(3*y**2*(-168+252*y**2)-105+336*y**2-252*y**4)*x**6+1/4*(3*y**2*(105-336*y**2+252*y**4)+20-105*y**2+168*y**4-84*y**6)*x**4+3/2*y**2*(-20+105*y**2-168*y**4+84*y**6)*x**2);
    zernike_intx[49]=-2*5**(1/2)*y*(-28*x**9+1/7*(-168+336*y**2)*x**7+1/5*(105-336*y**2+252*y**4+y**2*(-168+252*y**2))*x**5+1/3*(-20+105*y**2-168*y**4+84*y**6+y**2*(105-336*y**2+252*y**4))*x**3+y**2*(-20+105*y**2-168*y**4+84*y**6)*x-4/7*(-168+252*y**2)*x**7-4/5*(105-336*y**2+252*y**4)*x**5-4/3*(-20+105*y**2-168*y**4+84*y**6)*x**3);
    zernike_intx[50]=2*5**(1/2)*(18/5*x**10+1/8*(-288*y**2-56)*x**8+1/6*(216*y**4-10*y**2*(72*y**2-56)+21-56*y**2)*x**6+1/4*(5*y**4*(72*y**2-56)-10*y**2*(21+36*y**4-56*y**2))*x**4+5/2*y**4*(21+36*y**4-56*y**2)*x**2);
    zernike_intx[51]=2*5**(1/2)*y*(4*x**9+1/7*(144*y**2-56)*x**7+1/5*(21+72*y**4-56*y**2+2*y**2*(72*y**2-56))*x**5+1/3*(2*y**2*(21+36*y**4-56*y**2)+y**4*(72*y**2-56))*x**3+y**4*(21+36*y**4-56*y**2)*x+1/9*(36*(5**(1/2)-1)*(-1-5**(1/2))-72-72*5**(1/2)+36*(5**(1/2)-1)*(1-5**(1/2)))*x**9+1/7*(((5**(1/2)-1)*(-1-5**(1/2))-2-2*5**(1/2)+(5**(1/2)-1)*(1-5**(1/2)))*(72*y**2-56)+(36*(5**(1/2)-1)*(-1-5**(1/2))-72-72*5**(1/2)+36*(5**(1/2)-1)*(1-5**(1/2)))*y**2)*x**7+1/5*(((5**(1/2)-1)*(-1-5**(1/2))-2-2*5**(1/2)+(5**(1/2)-1)*(1-5**(1/2)))*(21+36*y**4-56*y**2)+((5**(1/2)-1)*(-1-5**(1/2))-2-2*5**(1/2)+(5**(1/2)-1)*(1-5**(1/2)))*(72*y**2-56)*y**2)*x**5+1/3*((5**(1/2)-1)*(-1-5**(1/2))-2-2*5**(1/2)+(5**(1/2)-1)*(1-5**(1/2)))*(21+36*y**4-56*y**2)*y**2*x**3+4*(5**(1/2)-1)*(-1-5**(1/2))*(5**(1/2)+1)*(1-5**(1/2))*x**9+1/7*(5**(1/2)-1)*(-1-5**(1/2))*(5**(1/2)+1)*(1-5**(1/2))*(72*y**2-56)*x**7+1/5*(5**(1/2)-1)*(-1-5**(1/2))*(5**(1/2)+1)*(1-5**(1/2))*(21+36*y**4-56*y**2)*x**5);
    zernike_intx[52]=2*5**(1/2)*(9/10*x**10+1/8*(-180*y**2-8)*x**8+1/6*(315*y**4-21*y**2*(-8+9*y**2))*x**6+1/4*(-63*y**6+35*y**4*(-8+9*y**2))*x**4-7/2*y**6*(-8+9*y**2)*x**2);
    zernike_intx[53]=-2*5**(1/2)*y*(-7*x**9+1/7*(-8+36*y**2)*x**7+1/5*(3*y**2*(-8+9*y**2)+27*y**4)*x**5+1/3*(3*y**4*(-8+9*y**2)+9*y**6)*x**3+y**6*(-8+9*y**2)*x-8/7*(-8+27*y**2)*x**7-8/5*(2*y**2*(-8+9*y**2)+9*y**4)*x**5-8*y**4*(-8+9*y**2)*x**3+16/7*(-8+18*y**2)*x**7+16/5*y**2*(-8+9*y**2)*x**5+1/7*(144*y**2+128)*x**7+1/5*(-144*y**4+32*y**2*(-8+9*y**2))*x**5);
    zernike_intx[54]=2*5**(1/2)*(1/10*x**10-9/2*x**8*y**2+21*x**6*y**4-21*x**4*y**6+9/2*y**8*x**2);
    zernike_intx[55]=2*5**(1/2)*y*(x**9-12*y**2*x**7+126/5*y**4*x**5-12*y**6*x**3+y**8*x);
    zernike_intx[56]=11**(1/2)*(252/11*x**11+140*y**2*x**9+360*y**4*x**7+504*y**6*x**5+420*y**8*x**3+252*y**10*x-70*x**9-360*y**2*x**7-756*y**4*x**5-840*y**6*x**3-630*y**8*x+80*x**7+336*y**2*x**5+560*y**4*x**3+560*y**6*x-42*x**5-140*x**3*y**2-210*x*y**4+10*x**3+30*x*y**2-x);
    zernike_intx[57]=2*22**(1/2)*y*(21*x**10+1/8*(-504+840*y**2)*x**8+1/6*(420-1512*y**2+1260*y**4)*x**6+1/4*(-140+840*y**2-1512*y**4+840*y**6)*x**4+1/2*(15-140*y**2+420*y**4-504*y**6+210*y**8)*x**2);
    zernike_intx[58]=-22**(1/2)*(-210/11*x**11+1/9*(-630*y**2+504)*x**9+1/7*(y**2*(-504+840*y**2)-420+1512*y**2-1260*y**4)*x**7+1/5*(y**2*(420-1512*y**2+1260*y**4)+140-840*y**2+1512*y**4-840*y**6)*x**5+1/3*(y**2*(-140+840*y**2-1512*y**4+840*y**6)-15+140*y**2-420*y**4+504*y**6-210*y**8)*x**3+y**2*(15-140*y**2+420*y**4-504*y**6+210*y**8)*x);
    zernike_intx[59]=-4*22**(1/2)*y*(-12*x**10+1/8*(-240*y**2+252)*x**8+1/6*(y**2*(-252+360*y**2)-168+504*y**2-360*y**4)*x**6+1/4*(y**2*(168-504*y**2+360*y**4)+35-168*y**2+252*y**4-120*y**6)*x**4+1/2*y**2*(-35+168*y**2-252*y**4+120*y**6)*x**2);
    zernike_intx[60]=22**(1/2)*(120/11*x**11+1/9*(-360*y**2-252)*x**9+1/7*(480*y**4-6*y**2*(-252+360*y**2)+168-504*y**2)*x**7+1/5*(y**4*(-252+360*y**2)-6*y**2*(168-504*y**2+360*y**4)-35+168*y**2-252*y**4+120*y**6)*x**5+1/3*(y**4*(168-504*y**2+360*y**4)-6*y**2*(-35+168*y**2-252*y**4+120*y**6))*x**3+y**4*(-35+168*y**2-252*y**4+120*y**6)*x);
    zernike_intx[61]=2*22**(1/2)*y*(27/2*x**10+1/8*(-216-180*y**2)*x**8+1/6*(-27*(15*y**2-14)*y**2+3*(-14-30*y**2)*(-2+3*y**2)-(-72-45*y**2)*y**2)*x**6+1/4*(-9*(15*y**2-14)*y**2*(-2+3*y**2)-(-9*(15*y**2-14)*y**2+(-14-30*y**2)*(-2+3*y**2))*y**2)*x**4+3/2*(15*y**2-14)*y**4*(-2+3*y**2)*x**2);
    zernike_intx[62]=22**(1/2)*(45/11*x**11+1/9*(-585*y**2-72)*x**9+1/7*(675*y**4-225*y**2*(-2+3*y**2)+(-42*y**2-2)*(15*y**2-14))*x**7+1/5*(-45*y**6+225*y**4*(-2+3*y**2)+(45*y**4-15*y**2*(-2+3*y**2))*(15*y**2-14))*x**5+1/3*(-15*y**6*(-2+3*y**2)+(-3*y**6+15*y**4*(-2+3*y**2))*(15*y**2-14))*x**3-y**6*(-2+3*y**2)*(15*y**2-14)*x);
    zernike_intx[63]=8*22**(1/2)*y*(x**10+1/8*(-60*y**2-9)*x**8+1/6*(70*y**4-7*y**2*(-9+10*y**2))*x**6+1/4*(-10*y**6+7*y**4*(-9+10*y**2))*x**4-1/2*y**6*(-9+10*y**2)*x**2);
    zernike_intx[64]=22**(1/2)*(10/11*x**11+1/9*(-270*y**2-9)*x**9+1/7*(700*y**4-28*y**2*(-9+10*y**2))*x**7+1/5*(-280*y**6+70*y**4*(-9+10*y**2))*x**5+1/3*(10*y**8-28*y**6*(-9+10*y**2))*x**3+y**8*(-9+10*y**2)*x);
    zernike_intx[65]=2*22**(1/2)*y*(1/2*x**10-15/2*x**8*y**2+21*x**6*y**4-15*x**4*y**6+5/2*y**8*x**2);
    zernike_intx[66]=22**(1/2)*(1/11*x**11-5*y**2*x**9+30*y**4*x**7-42*y**6*x**5+15*y**8*x**3-y**10*x);
    zernike_intx[67]=13**(1/2)*(420*x*y**4+280*x**3*y**2-42*x*y**2+84*x**5-240*x**7+x-252*x**11-2772*y**10*x-1540*y**2*x**9-3960*y**4*x**7-5544*y**6*x**5-4620*y**8*x**3+3150*y**8*x+924/13*x**13+504*x**11*y**2+2640*x**7*y**6+2772*y**8*x**5+1540*x**9*y**4+1848*y**10*x**3+924*y**12*x-1680*y**4*x**3-1680*y**6*x-14*x**3+3780*y**4*x**5+4200*y**6*x**3+350*x**9+1800*y**2*x**7-1008*y**2*x**5);
    zernike_intx[68]=15**(1/2)*(1144/5*x**15+1/13*(24024*y**2-12012)*x**13+1/11*((2*y**2-1)*(-5148+10296*y**2)+51480*y**4+11484-51480*y**2)*x**11+1/9*(45936*y**2-5808+68640*y**6-102960*y**4+(2*y**2-1)*(25740*y**4+5742-25740*y**2))*x**9+1/7*(1296-17424*y**2+68904*y**4+51480*y**8-102960*y**6+(2*y**2-1)*(22968*y**2-2904+34320*y**6-51480*y**4))*x**7+1/5*((2*y**2-1)*(648-8712*y**2+34452*y**4+25740*y**8-51480*y**6)-51480*y**8-17424*y**4+45936*y**6-108+2592*y**2+20592*y**10)*x**5+1/3*((2*y**2-1)*(-25740*y**8-8712*y**4+22968*y**6-54+1296*y**2+10296*y**10)+3432*y**12+2-108*y**2-10296*y**10-5808*y**6+1296*y**4+11484*y**8)*x**3+(2*y**2-1)*(1716*y**12+1-54*y**2-5148*y**10-2904*y**6+648*y**4+5742*y**8)*x);
    zernike_intx[69]=	(17**(1/2)*(x+19800*y**2*x**7-102960*y**4*x**7+41580*y**4*x**5+46200*y**6*x**3-5544*x**5*y**2-1320*x**7-72*x*y**2+252*x**5+1260*x*y**4+840*x**3*y**2-9240*y**6*x-9240*y**4*x**3+3850*x**9-24*x**3-27720*y**2*x**13+34320*y**14*x**3+72072*y**12*x**5+65520*y**6*x**11-40040*y**2*x**9-144144*y**6*x**5+12870*y**16*x+240240*y**6*x**7+45864*y**2*x**11-120120*y**12*x**3-216216*y**10*x**5-257400*y**8*x**7-98280*y**4*x**11-200200*y**6*x**9-51480*y**14*x+140140*y**4*x**9+100100*y**8*x**9+102960*y**10*x**7+34650*y**8*x-72072*y**10*x+6864*y**2*x**15+27720*y**4*x**13+84084*y**12*x+168168*y**10*x**3+252252*y**8*x**5-3432*x**15-6552*x**11+6468*x**13+12870/17*x**17-120120*y**8*x**3));
    zernike_intx[70]=	(19**(1/2)*(48620/19*x**19+1/17*(-218790+437580*y**2)*x**17+1/15*(-1361360*y**2+1361360*y**4+314600+(-97240+194480*y**2)*(2*y**2-1))*x**15+1/13*(-4084080*y**4-263120+2722720*y**6+1887600*y**2+(-680680*y**2+680680*y**4+157300)*(2*y**2-1))*x**13+1/11*(4719000*y**4-1315600*y**2+120692+3403400*y**8-6806800*y**6+(-2042040*y**4-131560+1361360*y**6+943800*y**2)*(2*y**2-1))*x**11+1/9*(482768*y**2+6292000*y**6-6806800*y**8-2631200*y**4+2722720*y**10-29744+(2359500*y**4-657800*y**2+60346+1701700*y**8-3403400*y**6)*(2*y**2-1))*x**9+1/7*(1361360*y**12+3608-4084080*y**10+724152*y**4-89232*y**2+4719000*y**8-2631200*y**6+(241384*y**2+3146000*y**6-3403400*y**8-1315600*y**4+1361360*y**10-14872)*(2*y**2-1))*x**7+1/5*(-1315600*y**8-176-89232*y**4+388960*y**14-1361360*y**12+1887600*y**10+7216*y**2+482768*y**6+(680680*y**12+1804-2042040*y**10+362076*y**4-44616*y**2+2359500*y**8-1315600*y**6)*(2*y**2-1))*x**5+1/3*(48620*y**16-194480*y**14-29744*y**6-176*y**2+2+3608*y**4+120692*y**8-263120*y**10+314600*y**12+(-657800*y**8-88-44616*y**4+194480*y**14-680680*y**12+943800*y**10+3608*y**2+241384*y**6)*(2*y**2-1))*x**3+(24310*y**16-97240*y**14-14872*y**6-88*y**2+1+1804*y**4+60346*y**8-131560*y**10+157300*y**12)*(2*y**2-1)*x));

    return zernike_intx[1:,:]; # Back to zero-based (Python)

def zernike_inty1(x,y,terms=70):
    zernike_inty=np.zeros( (terms+1, x.shape[0]) ) # Add one since these come from MATLAB and are one-based
    #zernike_inty[1]=0;
    zernike_inty[2]=2*x*y;
    zernike_inty[3]=y**2;
    zernike_inty[4]=3**(1/2)*(2*x**2*y+2/3*y**3-y);
    zernike_inty[5]=6**(1/2)*y**2*x;
    zernike_inty[6]=6**(1/2)*(x**2*y-1/3*y**3);
    zernike_inty[7]=2*2**(1/2)*(3/4*y**4+1/2*(-2+3*x**2)*y**2);
    zernike_inty[8]=2*2**(1/2)*x*(-2*y+3*x**2*y+y**3);
    zernike_inty[9]=2*2**(1/2)*(-1/4*y**4+3/2*x**2*y**2);
    zernike_inty[10]=2*2**(1/2)*x*(x**2*y-y**3);
    zernike_inty[11]=5**(1/2)*(6/5*y**5+4*x**2*y**3+6*x**4*y-6*x**2*y-2*y**3+y);
    zernike_inty[12]=10**(1/2)*(-4/5*y**5+y**3+x**2*(-3+4*x**2)*y);
    zernike_inty[13]=2*10**(1/2)*x*(y**4+1/2*(-3+4*x**2)*y**2);
    zernike_inty[14]=10**(1/2)*(1/5*y**5+x**4*y-2*x**2*y**3);
    zernike_inty[15]=4*10**(1/2)*x*(1/2*x**2*y**2-1/4*y**4);
    zernike_inty[16]=2*3**(1/2)*x*(3*y-12*x**2*y-4*y**3+2*y**5+20/3*x**2*y**3+10*x**4*y);
    zernike_inty[17]=2*3**(1/2)*(5/3*y**6+1/4*(-12+20*x**2)*y**4+1/2*(3-12*x**2+10*x**4)*y**2);
    zernike_inty[18]=2*3**(1/2)*x*(-3*y**5+1/3*(-10*x**2+12)*y**3+x**2*(-4+5*x**2)*y);
    zernike_inty[19]=-2*3**(1/2)*(5/6*y**6+1/4*(-4+10*x**2)*y**4+1/2*x**2*(-4+5*x**2)*y**2-4*x**2*(5/4*y**4+1/2*(-4+5*x**2)*y**2));
    zernike_inty[20]=2*3**(1/2)*x*(x**4*y-10/3*x**2*y**3+y**5);
    zernike_inty[21]=2*3**(1/2)*(1/6*y**6-5/2*x**2*y**4+5/2*x**4*y**2);
    zernike_inty[22]=7**(1/2)*(20/7*y**7+12*x**2*y**5+20*x**4*y**3+20*x**6*y-6*y**5-20*x**2*y**3-30*x**4*y+12*x**2*y+4*y**3-y);
    zernike_inty[23]=2*14**(1/2)*x*(5/2*y**6+1/4*(-20+30*x**2)*y**4+1/2*(6-20*x**2+15*x**4)*y**2);
    zernike_inty[24]=-14**(1/2)*(15/7*y**7+1/5*(15*x**2-20)*y**5+1/3*(-x**2*(-20+30*x**2)+6-20*x**2+15*x**4)*y**3-x**2*(6-20*x**2+15*x**4)*y);
    zernike_inty[25]=4*14**(1/2)*x*(-y**6+5/4*y**4+1/2*x**2*(-5+6*x**2)*y**2);
    zernike_inty[26]=14**(1/2)*(6/7*y**7+1/5*(-30*x**2-5)*y**5+1/3*(6*x**4-6*x**2*(-5+6*x**2))*y**3+x**4*(-5+6*x**2)*y);
    zernike_inty[27]=2*14**(1/2)*x*(1/2*y**6-5/2*x**2*y**4+3/2*x**4*y**2);
    zernike_inty[28]=14**(1/2)*(x**6*y-5*x**4*y**3+3*x**2*y**5-1/7*y**7);
    zernike_inty[29]=35/2*y**8+2/3*(-60+105*x**2)*y**6+(-120*x**2+30+105*x**4)*y**4+2*(-4+30*x**2+35*x**6-60*x**4)*y**2;
    zernike_inty[30]=4*x*(-4*y+30*x**2*y+10*y**3-12*y**5-40*x**2*y**3-60*x**4*y+5*y**7+21*x**2*y**5+35*x**4*y**3+35*x**6*y);
    zernike_inty[31]=-21/2*y**8-2/3*(-30+63*x**2)*y**6-(10-30*x**2+21*x**4+(-30+42*x**2)*x**2)*y**4-2*(10-30*x**2+21*x**4)*x**2*y**2+16*x**2*(7/2*y**6+1/4*(-30+42*x**2)*y**4+1/2*(10-30*x**2+21*x**4)*y**2);
    zernike_inty[32]=x*(-36*y**7+1/5*(-420*x**2+360)*y**5+1/3*(4*(-30+42*x**2)*x**2-120+360*x**2-252*x**4)*y**3+4*(10-30*x**2+21*x**4)*x**2*y);
    zernike_inty[33]=70*x**6*y**2+60*x**2*y**4-60*x**4*y**2-4*y**6+7/2*y**8-35*x**4*y**4-42*x**2*y**6;
    zernike_inty[34]=4*x*(5*y**7+1/5*(-35*x**2-30)*y**5+1/3*(7*x**4-10*x**2*(-6+7*x**2))*y**3+x**4*(-6+7*x**2)*y);
    zernike_inty[35]=14*x**6*y**2-35*x**4*y**4+14*x**2*y**6-1/2*y**8;
    zernike_inty[36]=4*x**7*y-28*x**5*y**3+28*y**5*x**3-4*y**7*x;
    zernike_inty[37]=70/3*y**9+120*x**2*y**7+252*x**4*y**5+280*x**6*y**3+210*x**8*y-60*y**7-252*x**2*y**5-420*x**4*y**3-420*x**6*y+54*y**5+180*x**2*y**3+270*x**4*y-60*x**2*y-20*y**3+3*y;
    zernike_inty[38]=-3*2**(1/2)*(56/9*y**9+1/7*(-105+224*x**2)*y**7+1/5*(-210*x**2+60+168*x**4+(-105+168*x**2)*x**2)*y**5+1/3*(-10+60*x**2+56*x**6-105*x**4+(-210*x**2+60+168*x**4)*x**2)*y**3+(-10+60*x**2+56*x**6-105*x**4)*x**2*y-2*x**2*(-10*y+60*x**2*y+20*y**3-21*y**5-70*x**2*y**3-105*x**4*y+8*y**7+168/5*x**2*y**5+56*x**4*y**3+56*x**6*y));
    zernike_inty[39]=6*2**(1/2)*x*(7*y**8+1/6*(-105+168*x**2)*y**6+1/4*(-210*x**2+60+168*x**4)*y**4+1/2*(-10+60*x**2+56*x**6-105*x**4)*y**2);
    zernike_inty[40]=3*2**(1/2)*(28/9*y**9+1/7*(-112*x**2-42)*y**7+1/5*(28*(-3*x**2+2*x**2*2**(1/2))*(-3*x**2-2*x**2*2**(1/2))-6*x**2*(-42+56*x**2)+15-42*x**2+28*x**4)*y**5+1/3*((-3*x**2+2*x**2*2**(1/2))*(-3*x**2-2*x**2*2**(1/2))*(-42+56*x**2)-6*x**2*(15-42*x**2+28*x**4))*y**3+(-3*x**2+2*x**2*2**(1/2))*(-3*x**2-2*x**2*2**(1/2))*(15-42*x**2+28*x**4)*y);
    zernike_inty[41]=-12*2**(1/2)*x*(7/2*y**8+1/6*(28*x**2-42)*y**6+1/4*(-x**2*(-42+56*x**2)+15-42*x**2+28*x**4)*y**4-1/2*x**2*(15-42*x**2+28*x**4)*y**2);
    zernike_inty[42]=3*2**(1/2)*(-8/9*y**9+1/7*(112*x**2+7)*y**7+1/6*(-4*(8*x**2-7)*x+(16*x**2-7)*x+(16*x**2+7)*x-4*(-8*x**2+7)*x-32*x**3)*y**6+1/5*(3*(8*x**2-7)*x**2+(-4*(8*x**2-7)*x+(16*x**2-7)*x)*x-4*(-4*(8*x**2-7)*x+(16*x**2-7)*x+(16*x**2+7)*x)*x+(-8*x**2+7)*x**2)*y**5+1/4*(4*(8*x**2-7)*x**3-4*(3*(8*x**2-7)*x**2+(-4*(8*x**2-7)*x+(16*x**2-7)*x)*x)*x+(-4*(8*x**2-7)*x+(16*x**2-7)*x+(16*x**2+7)*x)*x**2)*y**4+1/3*(-15*(8*x**2-7)*x**4+(3*(8*x**2-7)*x**2+(-4*(8*x**2-7)*x+(16*x**2-7)*x)*x)*x**2)*y**3+(8*x**2-7)*x**6*y);
    zernike_inty[43]=6*2**(1/2)*x*(3*y**8+1/6*(-56*x**2-21)*y**6+1/4*(-(8*x**2-7)*x**2+3*(-16*x**2+21)*x**2)*y**4+3/2*(8*x**2-7)*x**4*y**2);
    zernike_inty[44]=3*2**(1/2)*(x**8*y-28/3*x**6*y**3+14*x**4*y**5-4*x**2*y**7+1/9*y**9);
    zernike_inty[45]=24*2**(1/2)*x*(-1/8*y**8+7/6*x**2*y**6-7/4*x**4*y**4+1/2*x**6*y**2);
    zernike_inty[46]=2*5**(1/2)*x*(5*y-60*x**2*y-20*y**3+42*y**5+140*x**2*y**3+210*x**4*y-40*y**7-168*x**2*y**5-280*x**4*y**3-280*x**6*y+14*y**9+72*x**2*y**7+756/5*x**4*y**5+168*x**6*y**3+126*x**8*y);
    zernike_inty[47]=2*5**(1/2)*(63/5*y**10+1/8*(-280+504*x**2)*y**8+1/6*(210-840*x**2+756*x**4)*y**6+1/4*(420*x**2-840*x**4-60+504*x**6)*y**4+1/2*(5-60*x**2-280*x**6+210*x**4+126*x**8)*y**2);
    zernike_inty[48]=-2*5**(1/2)*x*(28*y**9+1/7*(672*x**2-504)*y**7+1/5*(-x**2*(-168+252*x**2)-1008*x**2+315+756*x**4)*y**5+1/3*(-x**2*(-336*x**2+105+252*x**4)-60+315*x**2+252*x**6-504*x**4)*y**3-x**2*(-20+105*x**2+84*x**6-168*x**4)*y);
    zernike_inty[49]=-2*5**(1/2)*(42/5*y**10+1/8*(-168+336*x**2)*y**8+1/6*(-336*x**2+105+252*x**4+x**2*(-168+252*x**2))*y**6+1/4*(-20+105*x**2+84*x**6-168*x**4+x**2*(-336*x**2+105+252*x**4))*y**4+1/2*x**2*(-20+105*x**2+84*x**6-168*x**4)*y**2-4*x**2*(21/2*y**8+1/6*(-168+252*x**2)*y**6+1/4*(-336*x**2+105+252*x**4)*y**4+1/2*(-20+105*x**2+84*x**6-168*x**4)*y**2));
    zernike_inty[50]=2*5**(1/2)*x*(20*y**9-40*y**7+1/5*(216*x**4-10*x**2*(-56+72*x**2)+105-280*x**2)*y**5+1/3*(x**4*(-56+72*x**2)-10*x**2*(21-56*x**2+36*x**4))*y**3+x**4*(21-56*x**2+36*x**4)*y);
    zernike_inty[51]=2*5**(1/2)*(18/5*y**10+1/8*(-56+144*x**2)*y**8+1/6*(21-56*x**2+72*x**4+2*x**2*(-56+72*x**2))*y**6+1/4*(2*x**2*(21-56*x**2+36*x**4)+x**4*(-56+72*x**2))*y**4+1/2*x**4*(21-56*x**2+36*x**4)*y**2+((-x+x*5**(1/2))*(-x-x*5**(1/2))-2*x*(x+x*5**(1/2))+(-x+x*5**(1/2))*(x-x*5**(1/2)))*(9/2*y**8+1/6*(-56+108*x**2)*y**6+1/4*(21-56*x**2+36*x**4+x**2*(-56+72*x**2))*y**4+1/2*x**2*(21-56*x**2+36*x**4)*y**2)+((-x+x*5**(1/2))*(-x-x*5**(1/2))*(x+x*5**(1/2))+((-x+x*5**(1/2))*(-x-x*5**(1/2))-2*x*(x+x*5**(1/2)))*(x-x*5**(1/2)))*(36/7*y**4*(x**2+y**2)**(3/2)-144/7*x**2*(1/5*y**2*(x**2+y**2)**(3/2)-2/15*x**2*(x**2+y**2)**(3/2))+(-56+72*x**2)*(1/5*y**2*(x**2+y**2)**(3/2)-2/15*x**2*(x**2+y**2)**(3/2))+1/3*(21-56*x**2+36*x**4)*(x**2+y**2)**(3/2))+(-x+x*5**(1/2))*(-x-x*5**(1/2))*(x+x*5**(1/2))*(x-x*5**(1/2))*(6*y**6+1/4*(-56+72*x**2)*y**4+1/2*(21-56*x**2+36*x**4)*y**2));
    zernike_inty[52]=2*5**(1/2)*x*(-7*y**9+1/7*(252*x**2+56)*y**7+1/5*(-189*x**4+35*x**2*(-8+9*x**2))*y**5+1/3*(9*x**6-21*x**4*(-8+9*x**2))*y**3+x**6*(-8+9*x**2)*y);
    zernike_inty[53]=-2*5**(1/2)*(9/10*y**10+1/8*(-8+36*x**2)*y**8+1/6*(3*x**2*(-8+9*x**2)+27*x**4)*y**6+1/4*(3*x**4*(-8+9*x**2)+9*x**6)*y**4-15/2*x**6*(-8+9*x**2)*y**2-8*x**2*(9/8*y**8+1/6*(-8+27*x**2)*y**6+1/4*(2*x**2*(-8+9*x**2)+9*x**4)*y**4+1/2*x**4*(-8+9*x**2)*y**2)+16*x**4*(3/2*y**6+1/4*(-8+18*x**2)*y**4+1/2*x**2*(-8+9*x**2)*y**2)-18*y**8*x**2+1/6*(288*x**4-16*x**2*(-8+9*x**2))*y**6+1/4*(-144*x**6+32*x**4*(-8+9*x**2))*y**4);
    zernike_inty[54]=2*5**(1/2)*x*(x**8*y-12*x**6*y**3+126/5*x**4*y**5-12*x**2*y**7+y**9);
    zernike_inty[55]=2*5**(1/2)*(1/10*y**10-9/2*y**8*x**2+21*x**4*y**6-21*x**6*y**4+9/2*x**8*y**2);
    zernike_inty[56]=11**(1/2)*(252/11*y**11+140*x**2*y**9+360*x**4*y**7+504*x**6*y**5+420*x**8*y**3+252*x**10*y-70*y**9-360*x**2*y**7-756*x**4*y**5-840*x**6*y**3-630*x**8*y+80*y**7+336*x**2*y**5+560*x**4*y**3+560*x**6*y-42*y**5-140*x**2*y**3-210*x**4*y+30*x**2*y+10*y**3-y);
    zernike_inty[57]=2*22**(1/2)*x*(21*y**10+1/8*(-504+840*x**2)*y**8+1/6*(420-1512*x**2+1260*x**4)*y**6+1/4*(840*x**2-1512*x**4-140+840*x**6)*y**4+1/2*(15-140*x**2-504*x**6+420*x**4+210*x**8)*y**2);
    zernike_inty[58]=-22**(1/2)*(210/11*y**11+1/9*(630*x**2-504)*y**9+1/7*(-x**2*(-504+840*x**2)+420-1512*x**2+1260*x**4)*y**7+1/5*(-x**2*(420-1512*x**2+1260*x**4)+840*x**2-1512*x**4-140+840*x**6)*y**5+1/3*(-x**2*(840*x**2-1512*x**4-140+840*x**6)+15-140*x**2-504*x**6+420*x**4+210*x**8)*y**3-x**2*(15-140*x**2-504*x**6+420*x**4+210*x**8)*y);
    zernike_inty[59]=-4*22**(1/2)*x*(12*y**10+1/8*(240*x**2-252)*y**8+1/6*(-x**2*(-252+360*x**2)-504*x**2+168+360*x**4)*y**6+1/4*(-x**2*(-504*x**2+168+360*x**4)-35+168*x**2+120*x**6-252*x**4)*y**4-1/2*x**2*(-35+168*x**2+120*x**6-252*x**4)*y**2);
    zernike_inty[60]=22**(1/2)*(120/11*y**11+1/9*(-360*x**2-252)*y**9+1/7*(480*x**4-6*x**2*(-252+360*x**2)-504*x**2+168)*y**7+1/5*(x**4*(-252+360*x**2)-6*x**2*(-504*x**2+168+360*x**4)-35+168*x**2+120*x**6-252*x**4)*y**5+1/3*(x**4*(-504*x**2+168+360*x**4)-6*x**2*(-35+168*x**2+120*x**6-252*x**4))*y**3+x**4*(-35+168*x**2+120*x**6-252*x**4)*y);
    zernike_inty[61]=2*22**(1/2)*x*(27/2*y**10+1/8*(-180*x**2-216)*y**8+1/6*(-3*(15*x**2-14)*x**2-(-30*x**2+42)*(-2+3*x**2)+3*(-225*x**2+216)*x**2)*y**6+1/4*(-(15*x**2-14)*x**2*(-2+3*x**2)+3*(3*(15*x**2-14)*x**2+(-30*x**2+42)*(-2+3*x**2))*x**2)*y**4+3/2*(15*x**2-14)*x**4*(-2+3*x**2)*y**2);
    zernike_inty[62]=22**(1/2)*(-45/11*y**11+1/9*(585*x**2+72)*y**9+1/7*(-675*x**4+225*x**2*(-2+3*x**2)+(42*x**2+2)*(15*x**2-14))*y**7+1/5*(45*x**6-225*x**4*(-2+3*x**2)+(-45*x**4+15*x**2*(-2+3*x**2))*(15*x**2-14))*y**5+1/3*(15*x**6*(-2+3*x**2)+(3*x**6-15*x**4*(-2+3*x**2))*(15*x**2-14))*y**3+x**6*(-2+3*x**2)*(15*x**2-14)*y);
    zernike_inty[63]=8*22**(1/2)*x*(-y**10+1/8*(60*x**2+9)*y**8+1/6*(-70*x**4+7*x**2*(-9+10*x**2))*y**6+1/4*(10*x**6-7*x**4*(-9+10*x**2))*y**4+1/2*x**6*(-9+10*x**2)*y**2);
    zernike_inty[64]=22**(1/2)*(10/11*y**11+1/9*(-270*x**2-9)*y**9+1/7*(700*x**4-28*x**2*(-9+10*x**2))*y**7+1/5*(-280*x**6+70*x**4*(-9+10*x**2))*y**5+1/3*(10*x**8-28*x**6*(-9+10*x**2))*y**3+x**8*(-9+10*x**2)*y);
    zernike_inty[65]=2*22**(1/2)*x*(1/2*y**10-15/2*y**8*x**2+21*x**4*y**6-15*x**6*y**4+5/2*x**8*y**2);
    zernike_inty[66]=22**(1/2)*(-1/11*y**11+5*x**2*y**9-30*x**4*y**7+42*x**6*y**5-15*x**8*y**3+x**10*y);

    zernike_inty[67]=13**(1/2)*(280*x**2*y**3+y-1008*x**2*y**5-1680*x**4*y**3-14*y**3+84*y**5-240*y**7+420*x**4*y-1680*x**6*y-42*x**2*y+350*y**9+1800*x**2*y**7+3780*x**4*y**5+4200*x**6*y**3+3150*x**8*y-1540*x**2*y**9-3960*x**4*y**7-5544*x**6*y**5-4620*x**8*y**3-2772*x**10*y-252*y**11+2772*x**8*y**5+1540*x**4*y**9+1848*x**10*y**3+2640*x**6*y**7+504*x**2*y**11+924*x**12*y+924/13*y**13);
    zernike_inty[68]=15**(1/2)*(1144/5*y**15+1/13*(24024*x**2-12012)*y**13+1/11*((2*x**2-1)*(-5148+10296*x**2)+51480*x**4+11484-51480*x**2)*y**11+1/9*(45936*x**2-5808+68640*x**6-102960*x**4+(2*x**2-1)*(25740*x**4+5742-25740*x**2))*y**9+1/7*(1296-17424*x**2+68904*x**4+51480*x**8-102960*x**6+(2*x**2-1)*(22968*x**2-2904+34320*x**6-51480*x**4))*y**7+1/5*((2*x**2-1)*(648-8712*x**2+34452*x**4+25740*x**8-51480*x**6)-17424*x**4+2592*x**2+45936*x**6-51480*x**8+20592*x**10-108)*y**5+1/3*((2*x**2-1)*(-8712*x**4+1296*x**2+22968*x**6-25740*x**8+10296*x**10-54)+3432*x**12+2-10296*x**10-108*x**2-5808*x**6+1296*x**4+11484*x**8)*y**3+(2*x**2-1)*(1716*x**12+1-5148*x**10-54*x**2-2904*x**6+648*x**4+5742*x**8)*y);
    zernike_inty[69]=	(17**(1/2)*(-120120*x**12*y**3-216216*x**10*y**5-1320*y**7+252*y**5-120120*x**8*y**3+34650*x**8*y+19800*x**2*y**7-102960*x**4*y**7-40040*x**2*y**9-200200*x**6*y**9+100100*x**8*y**9+41580*x**4*y**5+46200*x**6*y**3+y-257400*x**8*y**7-51480*x**14*y+27720*x**4*y**13+6864*x**2*y**15+840*x**2*y**3+1260*x**4*y-27720*x**2*y**13-98280*x**4*y**11-72*x**2*y-5544*x**2*y**5-9240*x**4*y**3-9240*x**6*y-24*y**3+140140*x**4*y**9+45864*x**2*y**11+84084*x**12*y+72072*x**12*y**5+12870*x**16*y+34320*x**14*y**3+102960*x**10*y**7+65520*x**6*y**11-72072*x**10*y+252252*x**8*y**5+168168*x**10*y**3-144144*x**6*y**5+240240*x**6*y**7-3432*y**15-6552*y**11+3850*y**9+6468*y**13+12870/17*y**17));
    zernike_inty[70]=	(19**(1/2)*(48620/19*y**19+1/17*(-218790+437580*x**2)*y**17+1/15*(-1361360*x**2+1361360*x**4+314600+(-97240+194480*x**2)*(2*x**2-1))*y**15+1/13*(-4084080*x**4-263120+2722720*x**6+1887600*x**2+(-680680*x**2+680680*x**4+157300)*(2*x**2-1))*y**13+1/11*(4719000*x**4-1315600*x**2+120692+3403400*x**8-6806800*x**6+(-2042040*x**4-131560+1361360*x**6+943800*x**2)*(2*x**2-1))*y**11+1/9*(482768*x**2+6292000*x**6-6806800*x**8-2631200*x**4+2722720*x**10-29744+(2359500*x**4-657800*x**2+60346+1701700*x**8-3403400*x**6)*(2*x**2-1))*y**9+1/7*(1361360*x**12+3608-4084080*x**10+724152*x**4-89232*x**2+4719000*x**8-2631200*x**6+(241384*x**2+3146000*x**6-3403400*x**8-1315600*x**4+1361360*x**10-14872)*(2*x**2-1))*y**7+1/5*(-176-1315600*x**8-89232*x**4+388960*x**14-1361360*x**12+1887600*x**10+7216*x**2+482768*x**6+(680680*x**12+1804-2042040*x**10+362076*x**4-44616*x**2+2359500*x**8-1315600*x**6)*(2*x**2-1))*y**5+1/3*(48620*x**16-194480*x**14-176*x**2-263120*x**10+2+3608*x**4-29744*x**6+314600*x**12+120692*x**8+(-88-657800*x**8-44616*x**4+194480*x**14-680680*x**12+943800*x**10+3608*x**2+241384*x**6)*(2*x**2-1))*y**3+(24310*x**16-97240*x**14-88*x**2-131560*x**10+1+1804*x**4-14872*x**6+157300*x**12+60346*x**8)*(2*x**2-1)*y));
    return zernike_inty[1:,:]; # Back to zero-based (Python)

# Combine the four corners of the box:
def zernike_integral_average_from_corners(left,right,upper,lower,pupil_radius,terms=71):
    spacing_x = right - left;
    spacing_y = upper - lower;

    intx=(zernike_intx1(right,upper) - zernike_intx1(left,upper) -
          zernike_intx1(right,lower) + zernike_intx1(left,lower))/spacing_x/spacing_y
    inty=(zernike_inty1(right,upper) - zernike_inty1(left,upper) -
          zernike_inty1(right,lower) + zernike_inty1(left,lower))/spacing_x/spacing_y
    return intx/pupil_radius,inty/pupil_radius
